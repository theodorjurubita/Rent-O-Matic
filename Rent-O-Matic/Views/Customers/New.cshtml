@model Rent_O_Matic.ViewModels.CustomerViewModel
@{
    ViewBag.Title = "New";
    Layout = "~/Views/Shared/_Layout.cshtml";
}



@if (Model.Customer == null)
{
    <h2>New Customer</h2>
}
else
{
    <h2>Edit Customer</h2>
}

@using (Html.BeginForm("Save", "Customers", new { id = "CustomerForm" }))
{
    <div class="form-group">
        @Html.LabelFor(m => m.Customer.Name)
        @Html.TextBoxFor(m => m.Customer.Name, new { @class = "form-control", id = "customerName", autofocus = "autofocus" })
        @Html.ValidationMessageFor(m => m.Customer.Name)
    </div>
    <div class="form-group">
        @Html.LabelFor(m => m.Customer.Nationality)
        @Html.TextBoxFor(m => m.Customer.Nationality, new { @class = "form-control" })
        @Html.ValidationMessageFor(m => m.Customer.Nationality)
    </div>
    <div>
        @Html.LabelFor(m => m.Customer.YearsOld)
        @Html.TextBoxFor(m => m.Customer.YearsOld, new { @class = "form-control" })
        @Html.ValidationMessageFor(m => m.Customer.YearsOld)
    </div>
    <div class="form-group">
        @Html.LabelFor(m => m.Customer.DrivingLiscense)
        @Html.TextBoxFor(m => m.Customer.DrivingLiscense, new { @class = "form-control" })
        @Html.ValidationMessageFor(m => m.Customer.DrivingLiscense)
    </div>
    <div class="form-group">
        @Html.LabelFor(m => m.Customer.StoreId)
        @Html.DropDownListFor(m => m.Customer.StoreId, new SelectList(Model.Stores, "Id", "City"), "Select Store", new { @class = "form-control", id = "storeddl", @onchange = "javascript:GetCars(this.value);" })
        @Html.ValidationMessageFor(m => m.Customer.StoreId)
    </div>

    <div class="form-group">
        @Html.LabelFor(m => m.Customer.CarId)
        <select type="submit" id="ddlCars" name="Customer.CarId" class="form-control">
            <option>Select a store first!</option>
        </select>
        @Html.ValidationMessageFor(m => m.Customer.CarId)
    </div>

    @Html.HiddenFor(m => m.Customer.Id)

    if (@Model.Customer != null)
    {
        <div data-car-id="@Model.Customer.CarId" hidden="true" id="helperDivCar"></div>
    }


    <button type="submit" class="btn btn-primary " id="submitBTN">
        Save
    </button>



    @section Scripts{
        <script language="javascript" type="text/javascript">

            if ($("#helperDivCar").attr("data-car-id") == null) {
                $.holdReady(true);
            }
            $(document).ready(function () {
                if ($("#customerName").text != null) {
                    $.ajax({
                        url: "/Customers/GetCarBrandById",
                        data: { id: $("#helperDivCar").attr("data-car-id") },
                        cache: false,
                        type: "POST",
                        success: function (data) {
                            var markup = "<option value=" +
                                data[data.length - 1].Value +
                                ">" +
                                data[data.length - 1].Text +
                                "</option>";

                            $("#ddlCars").html(markup).show();
                        },
                        error: function (response) {
                            alert("error : " + response);
                        }
                    });
                }
            });


            function GetCars(_storeId) {
                if (_storeId) {
                    $.ajax({
                        url: "/Customers/GetCarsByStoreId/",
                        data: { storeId: _storeId },
                        cache: false,
                        type: "POST",
                        success: function (data) {
                            var markup = "<option value='0'>Select Car</option>";
                            for (var x = 0; x < data.length; x++) {
                                markup += "<option value=" + data[x].Value + ">" + data[x].Text + "</option>";
                            }
                            $("#ddlCars").html(markup).show();
                        },
                        error: function (reponse) {
                            alert("error : " + reponse);
                        }
                    });
                } else {
                    var markup = "<option value='0'>Select a Store first!</option>";
                    $("#ddlCars").html(markup).show();
                }
            }


        </script>
    }
}